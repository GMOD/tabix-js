# @gmod/tabix

[![NPM version](https://img.shields.io/npm/v/@gmod/tabix.svg?style=flat-square)](https://npmjs.org/package/@gmod/tabix)
[![Build Status](https://img.shields.io/travis/GMOD/tabix-js/master.svg?style=flat-square)](https://travis-ci.org/GMOD/tabix-js)
[![Greenkeeper badge](https://badges.greenkeeper.io/GMOD/tabix-js.svg)](https://greenkeeper.io/)

Read Tabix-indexed files using either .tbi or .csi indexes.

## Install

    $ npm install --save @gmod/tabix

## Usage

```js
const {TabixIndexedFile} = require('@gmod/tabix')

const tbiIndexed = new TabixIndexedFile({ path: 'path/to/my/file.gz' })
// by default, assumes tabix index at path/to/my/file.gz.tbi.
// can also provide `tbiPath` if the TBI is named differently

// can also open tabix files that have a .csi index
const csiIndexed = new TabixIndexedFile({
  path: 'path/to/my/file.gz',
  csiPath: 'path/to/my/file.gz.csi'
})

// use a remote file or other filehandle, note RemoteFile comes from https://github.com/GMOD/generic-filehandle
const {RemoteFile} = require('generic-filehandle')
const remoteTbiIndexed = new TabixIndexedFile({
  filehandle: new RemoteFile('http://yourhost/file.vcf.gz'),
  tbiFilehandle: new RemoteFile('http://yourhost/file.vcf.gz.tbi') // can also be csiFilehandle
})

// iterate over lines in the specified region
const lines = []
await tbiIndexed.getLines('ctgA',200,300, (line, fileOffset) => lines.push(line))
// alternative API usage
const aborter = new AbortController()
await tbiIndexed.getLines('ctgA',200,300, {
  lineCallback: (line, fileOffset) => lines.push(line),
  signal: aborter.signal // an optional AbortSignal from an AbortController
})
// lines is now an array of strings, which are data lines.
// commented (meta) lines are skipped.
// line strings do not include any trailing whitespace characters.
// the callback is also called with a `fileOffset`,
// which gives the virtual file offset where the line is found in the file

// get the approximate number of data lines in the
// file for the given reference sequence, excluding header, comment, and whitespace lines
const numLines = await tbiIndexed.lineCount('ctgA')
// or const numLines = await tbiIndexed.lineCount('ctgA', { signal: aborter.signal })

// get the "header text" string from the file, which is the first contiguous
// set of lines in the file that all start with a "meta" character (usually #)
const headerText = await tbiIndexed.getHeader()
// or const headerText = await tbiIndexed.getHeader({ signal: aborter.signal })

// or if you want a nodejs Buffer object instead, there is getHeaderBuffer()
const headerBuffer = await tbiIndexed.getHeaderBuffer()
// or const headerBuffer = await tbiIndexed.getHeaderBuffer({ signal: aborter.signal })
```

You may also use e.g. `tbiIndexed.getLines('ctgA', 200, undefined, lineCallback)`
to get all lines starting at 200 and going to the end of ctgA.

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [TabixIndexedFile](#tabixindexedfile)
    -   [Parameters](#parameters)
    -   [getLines](#getlines)
        -   [Parameters](#parameters-1)
    -   [getMetadata](#getmetadata)
        -   [Parameters](#parameters-2)
    -   [getHeader](#getheader)
        -   [Parameters](#parameters-3)
    -   [getHeaderBuffer](#getheaderbuffer)
        -   [Parameters](#parameters-4)
    -   [getReferenceSequenceNames](#getreferencesequencenames)
        -   [Parameters](#parameters-5)
    -   [lineCount](#linecount)
        -   [Parameters](#parameters-6)
-   [Metadata](#metadata)
    -   [Properties](#properties)
-   [AbortSignal](#abortsignal)
    -   [Properties](#properties-1)
-   [Options](#options)
    -   [Properties](#properties-2)
-   [getLinesCallback](#getlinescallback)
    -   [Parameters](#parameters-7)
-   [GetLinesOptions](#getlinesoptions)
    -   [Properties](#properties-3)
-   [TabixIndex](#tabixindex)
    -   [Parameters](#parameters-8)
    -   [getMetadata](#getmetadata-1)
        -   [Parameters](#parameters-9)
-   [VirtualOffset](#virtualoffset)
    -   [Parameters](#parameters-10)
-   [CSI](#csi)
    -   [Parameters](#parameters-11)
    -   [getMetadata](#getmetadata-2)
        -   [Parameters](#parameters-12)

### TabixIndexedFile

File indexed with a tabix (TBI) or CSI index

#### Parameters

-   `args` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `args.path` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** Must provide either `path` of `filehandle`
    -   `args.filehandle` **filehandle?** Must provide either `path` of
        `filehandle`
    -   `args.tbiPath` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** If `path` is provided, this defaults to
        \``${path}.tbi`\`
    -   `args.tbiFilehandle` **filehandle?** Unless `path` is provided, must
        provide one of `tbiFilehandle`, `tbiPath`, `csiFilehandle`, or `csiPath`
    -   `args.csiPath` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** Unless `path` is provided, must provide one
        of `tbiFilehandle`, `tbiPath`, `csiFilehandle`, or `csiPath`
    -   `args.csiFilehandle` **filehandle?** Unless `path` is provided, must
        provide one of `tbiFilehandle`, `tbiPath`, `csiFilehandle`, or `csiPath`
    -   `args.chunkSizeLimit` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Maximum number of bytes to
        fetch in a single `getLines` call. (optional, default `2000000`)
    -   `args.yieldLimit` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** Maximum number of lines to parse
        without yielding. This avoids having a large read prevent any other work
        getting done on the thread. (optional, default `300`)
    -   `args.renameRefSeqs` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** Optional function with signature
        `string => string` to transform reference sequence names for the purpose of
        indexing and querying. Note that the data that is returned is not altered,
        just the names of the reference sequences that are used for querying. (optional, default `n=>n`)
    -   `args.chunkCacheSize` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** maximum size in bytes of the
        chunk cache. (optional, default `5242880`)

#### getLines

Get the lines in the given region

##### Parameters

-   `refName` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Name of the reference sequence
-   `start` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** start of the region (in 0-based half-open
    coordinates) (optional, default `0`)
-   `end` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** End of the region (in 0-based half-open
    coordinates) (optional, default `Metadata.maxRefLength`)
-   `opts` **([getLinesCallback](#getlinescallback) \| [GetLinesOptions](#getlinesoptions))** Either a callback called for each line in
    the region, called as `(line, fileOffset) => {}` or object containing
    obj.lineCallback, obj.signal, etc

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[undefined](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/undefined)>** resolved when the whole read is finished, rejected on error

#### getMetadata

Get metadata from the index file

##### Parameters

-   `opts` **[Options](#options)** options

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[Metadata](#metadata)>** Metadata

#### getHeader

Get the "header" as a string

##### Parameters

-   `opts` **[Options](#options)** options (optional, default `{}`)

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>** The header, i.e. the portion up to the first
non-metadata line

#### getHeaderBuffer

Get the "header" as a buffer

##### Parameters

-   `opts` **[Options](#options)** options

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[Buffer](https://nodejs.org/api/buffer.html)>** The header, i.e. the portion up to the first
non-metadata line

#### getReferenceSequenceNames

Get an array of reference sequence names, in the order in which they occur
in the file

Reference sequence renaming is not applied to these names

##### Parameters

-   `opts` **[Options](#options)** options

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>>** The reference sequence names

#### lineCount

Get the approximate number of data lines in the given reference sequence

##### Parameters

-   `refSeq` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** reference sequence name
-   `opts`  

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)>** number of data lines present on that reference
sequence

### Metadata

Metadata from the index file

Type: [Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)

#### Properties

-   `columnNumbers` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `columnNumbers.ref` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** 
    -   `columnNumbers.start` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** 
    -   `columnNumbers.end` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** 
-   `metaChar` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
-   `format` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
-   `coordinateType` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
-   `skipLines` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** 
-   `refIdToName` **[Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)>** 
-   `refNameToId` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)&lt;[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String), [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)>** 
-   `firstDataLine` **[VirtualOffset](#virtualoffset)** 
-   `maxBlockSize` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** 
-   `maxBinNumber` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** 
-   `maxRefLength` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** 

### AbortSignal

An abort signal

Type: [Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)

#### Properties

-   `aborted` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** Indicates whether the request(s) the signal is
    communicating with is/are aborted

### Options

Common options

Type: [Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)

#### Properties

-   `signal` **[AbortSignal](#abortsignal)?** An abort signal

### getLinesCallback

Callback for each line

Type: [Function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)

#### Parameters

-   `line` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** The text of the line
-   `fileOffset` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** The file offset of the beginning of the line in the
    uncompressed file

### GetLinesOptions

getLines options

Type: [Options](#options)

#### Properties

-   `lineCallback` **[getLinesCallback](#getlinescallback)** A line callback

### TabixIndex

Tabix (TBI) index

#### Parameters

-   `args` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `args.filehandle` **filehandle** 
    -   `args.renameRefSeqs` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** Optional function with signature
        `string => string` to transform reference sequence names for the purpose of
        indexing and querying. Note that the data that is returned is not altered,
        just the names of the reference sequences that are used for querying. (optional, default `n=>n`)

#### getMetadata

##### Parameters

-   `opts` **[Options](#options)** options

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[Metadata](#metadata)>** Metadata

### VirtualOffset

Virtual offset

#### Parameters

-   `blockPosition`  
-   `dataPosition`  

### CSI

CSI index

#### Parameters

-   `args` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `args.filehandle` **filehandle** 
    -   `args.renameRefSeqs` **[function](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function)** Optional function with signature
        `string => string` to transform reference sequence names for the purpose of
        indexing and querying. Note that the data that is returned is not altered,
        just the names of the reference sequences that are used for querying. (optional, default `n=>n`)

#### getMetadata

##### Parameters

-   `opts` **[Options](#options)** options

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;[Metadata](#metadata)>** Metadata

## Academic Use

This package was written with funding from the [NHGRI](http://genome.gov) as part of the [JBrowse](http://jbrowse.org) project. If you use it in an academic project that you publish, please cite the most recent JBrowse paper, which will be linked from [jbrowse.org](http://jbrowse.org).

## License

MIT © [Robert Buels](https://github.com/rbuels)
